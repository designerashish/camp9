<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VWO Campaign Report Generator - Advanced</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            color: #2d3748;
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            color: #718096;
            font-size: 16px;
        }

        .upload-section {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }

        .upload-area {
            border: 3px dashed #cbd5e0;
            border-radius: 8px;
            padding: 60px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f7fafc;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: #edf2f7;
        }

        .upload-area.dragover {
            border-color: #667eea;
            background: #e6f2ff;
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 20px;
            color: #667eea;
        }

        .upload-text {
            font-size: 18px;
            color: #2d3748;
            margin-bottom: 10px;
        }

        .upload-subtext {
            font-size: 14px;
            color: #718096;
        }

        #fileInput {
            display: none;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }

        .btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .report-container {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .recommendations-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            color: white;
        }

        .recommendations-section h2 {
            font-size: 28px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .recommendation-card {
            background: rgba(255, 255, 255, 0.95);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            color: #2d3748;
            border-left: 4px solid #48bb78;
        }

        .recommendation-card.warning {
            border-left-color: #f59e0b;
        }

        .recommendation-card.critical {
            border-left-color: #ef4444;
        }

        .recommendation-card h3 {
            font-size: 18px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .recommendation-card p {
            font-size: 14px;
            line-height: 1.6;
            color: #4a5568;
        }

        .recommendation-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .badge-winner {
            background: #48bb78;
            color: white;
        }

        .badge-caution {
            background: #f59e0b;
            color: white;
        }

        .badge-info {
            background: #3b82f6;
            color: white;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
        }

        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.15);
        }

        .metric-label {
            color: #718096;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
        }

        .metric-value {
            color: #2d3748;
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .metric-change {
            font-size: 14px;
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-block;
        }

        .metric-change.positive {
            background: #d4edda;
            color: #155724;
        }

        .metric-change.negative {
            background: #f8d7da;
            color: #721c24;
        }

        .metric-change.neutral {
            background: #e2e8f0;
            color: #2d3748;
        }

        .lift-calculator {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .lift-calculator h2 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .lift-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .lift-item {
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .lift-item h4 {
            font-size: 14px;
            color: #718096;
            margin-bottom: 8px;
        }

        .lift-value {
            font-size: 24px;
            font-weight: bold;
            color: #2d3748;
        }

        .lift-value.positive {
            color: #48bb78;
        }

        .lift-value.negative {
            color: #ef4444;
        }

        .data-table-container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            overflow-x: auto;
        }

        .data-table-container h2 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .table-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .filter-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .filter-select {
            padding: 8px 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        thead {
            background: #f7fafc;
        }

        th {
            padding: 15px;
            text-align: left;
            color: #2d3748;
            font-weight: 600;
            border-bottom: 2px solid #e2e8f0;
            white-space: nowrap;
            cursor: pointer;
            user-select: none;
        }

        th:hover {
            background: #edf2f7;
        }

        th .sort-icon {
            margin-left: 5px;
            opacity: 0.3;
        }

        th.sorted .sort-icon {
            opacity: 1;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
            color: #4a5568;
        }

        tbody tr:hover {
            background: #f7fafc;
        }

        .winner-badge {
            background: #48bb78;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .control-badge {
            background: #718096;
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .confidence-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .confidence-high {
            background: #48bb78;
            color: white;
        }

        .confidence-medium {
            background: #f59e0b;
            color: white;
        }

        .confidence-low {
            background: #94a3b8;
            color: white;
        }

        .export-btn {
            background: #48bb78;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .export-btn:hover {
            background: #38a169;
            transform: translateY(-2px);
        }

        .campaign-info {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .campaign-info h2 {
            color: #2d3748;
            margin-bottom: 15px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .info-item {
            display: flex;
            flex-direction: column;
        }

        .info-label {
            color: #718096;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .info-value {
            color: #2d3748;
            font-size: 16px;
            font-weight: 500;
        }

        .loader {
            display: none;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .chart-container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .chart-container h2 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .error-message {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
            display: none;
        }

        .bar-item {
            margin-bottom: 20px;
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
        }

        .bar-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }

        .bar-label {
            font-weight: 600;
            color: #2d3748;
            font-size: 16px;
        }

        .bar-value {
            font-weight: bold;
            font-size: 18px;
        }

        .bar-bg {
            background: #e2e8f0;
            height: 40px;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }

        .bar-fill {
            height: 100%;
            transition: width 0.8s ease;
            display: flex;
            align-items: center;
            padding-left: 15px;
            color: white;
            font-weight: 600;
        }

        .debug-info {
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            white-space: pre-wrap;
            word-wrap: break-word;
            display: none;
        }

        .impact-calculator {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .impact-calculator h2 {
            color: #2d3748;
            margin-bottom: 20px;
        }

        .calculator-input {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .calculator-input label {
            font-size: 14px;
            color: #4a5568;
        }

        .calculator-input input {
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            width: 150px;
        }

        .impact-result {
            padding: 20px;
            background: linear-gradient(135deg, #667eea15, #764ba215);
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .impact-result h3 {
            font-size: 20px;
            color: #2d3748;
            margin-bottom: 10px;
        }

        .impact-value {
            font-size: 32px;
            font-weight: bold;
            color: #48bb78;
        }

        @media print {
            body {
                background: white;
            }
            .upload-section, .btn, .export-btn, .debug-info, .calculator-input {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ VWO Campaign Report Generator</h1>
            <p>Advanced Analytics with AI-Powered Recommendations</p>
        </div>

        <div class="upload-section">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">üìä</div>
                <div class="upload-text">Drag & Drop your CSV file here</div>
                <div class="upload-subtext">or click to browse</div>
                <input type="file" id="fileInput" accept=".csv">
            </div>
            <div class="error-message" id="errorMessage"></div>
            <div class="loader" id="loader"></div>
        </div>

        <div class="report-container" id="reportContainer">
            <div class="debug-info" id="debugInfo"></div>
            
            <div class="table-controls" style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 30px;">
                <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
                    <div>
                        <label style="font-weight: 600; color: #2d3748; margin-right: 10px;">Filter by Metric:</label>
                        <select class="filter-select" id="metricFilter" style="padding: 10px 15px; font-size: 16px;">
                            <option value="all">All Metrics</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <button class="export-btn" onclick="toggleDebug()">üêõ Debug</button>
                        <button class="export-btn" onclick="exportToCSV()">üìä Export CSV</button>
                        <button class="export-btn" onclick="window.print()">üñ®Ô∏è Print</button>
                    </div>
                </div>
            </div>
            
            <div class="recommendations-section" id="recommendationsSection"></div>
            
            <div class="campaign-info" id="campaignInfo"></div>
            
            <div class="metrics-grid" id="metricsGrid"></div>
            
            <div class="lift-calculator" id="liftCalculator"></div>
            
            <div class="impact-calculator" id="impactCalculator"></div>
            
            <div class="chart-container" id="chartContainer"></div>
            
            <div class="data-table-container">
                <h2>Detailed Campaign Data</h2>
                <div id="tableContainer"></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script>
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const loader = document.getElementById('loader');
        const reportContainer = document.getElementById('reportContainer');
        const errorMessage = document.getElementById('errorMessage');
        const debugInfo = document.getElementById('debugInfo');

        let debugData = [];
        let campaignMetadata = {};
        let globalData = [];
        let globalHeaders = [];
        let currentSort = { column: null, ascending: true };
        let currentMetricFilter = 'all';

        function toggleDebug() {
            debugInfo.style.display = debugInfo.style.display === 'none' ? 'block' : 'none';
        }

        function addDebug(msg) {
            const timestamp = new Date().toLocaleTimeString();
            debugData.push(`[${timestamp}] ${msg}`);
            debugInfo.textContent = debugData.join('\n');
            console.log(msg);
        }

        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                handleFile(e.dataTransfer.files[0]);
            }
        });
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
            loader.style.display = 'none';
            addDebug('‚ùå ERROR: ' + message);
        }

        function hideError() {
            errorMessage.style.display = 'none';
        }

        function handleFile(file) {
            debugData = [];
            campaignMetadata = {};
            addDebug('üìÅ File: ' + file.name + ' (' + file.size + ' bytes)');
            
            if (!file.name.endsWith('.csv')) {
                showError('Please upload a valid CSV file');
                return;
            }

            hideError();
            loader.style.display = 'block';
            reportContainer.style.display = 'none';

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csvData = e.target.result;
                    addDebug('‚úÖ File read: ' + csvData.length + ' characters');
                    processVWOCSV(csvData);
                    loader.style.display = 'none';
                    reportContainer.style.display = 'block';
                } catch (error) {
                    showError('Error: ' + error.message);
                    addDebug('‚ùå ' + error.stack);
                }
            };
            reader.onerror = function() {
                showError('Error reading file');
            };
            reader.readAsText(file, 'UTF-8');
        }

        function processVWOCSV(csvData) {
            addDebug('üîÑ Processing VWO format CSV...');
            
            const lines = csvData.split(/\r?\n/);
            addDebug('üìä Total lines: ' + lines.length);
            
            let dataStartIndex = 0;
            for (let i = 0; i < Math.min(10, lines.length); i++) {
                const line = lines[i].trim();
                if (line.includes('Campaign Name:')) {
                    campaignMetadata.name = line.split(':')[1].trim();
                    addDebug('üìã Campaign Name: ' + campaignMetadata.name);
                }
                if (line.includes('Campaign Id:')) {
                    campaignMetadata.id = line.split(':')[1].trim();
                    addDebug('üìã Campaign ID: ' + campaignMetadata.id);
                }
                if (line.includes('Metric,') || line.startsWith('Metric,')) {
                    dataStartIndex = i;
                    addDebug('‚úÖ Data starts at line ' + (i + 1));
                    break;
                }
            }
            
            if (dataStartIndex === 0) {
                throw new Error('Could not find data table in CSV');
            }
            
            const dataCSV = lines.slice(dataStartIndex).join('\n');
            addDebug('üìÑ Parsing data section...');
            
            Papa.parse(dataCSV, {
                header: true,
                dynamicTyping: false,
                skipEmptyLines: true,
                complete: function(results) {
                    addDebug('‚úÖ Parse complete');
                    addDebug('üìä Data rows: ' + results.data.length);
                    
                    globalData = results.data;
                    globalHeaders = results.meta.fields;
                    
                    if (results.data.length === 0) {
                        throw new Error('No data rows found');
                    }
                    
                    generateReport(results.data, results.meta.fields);
                },
                error: function(error) {
                    throw new Error('Parse error: ' + error.message);
                }
            });
        }

        function extractNumber(value) {
            if (value === undefined || value === null || value === '') return null;
            const str = String(value).trim();
            const cleaned = str.replace(/[$,‚Ç¨¬£¬•%\s]/g, '');
            const num = parseFloat(cleaned);
            return isNaN(num) ? null : num;
        }

        function getFilteredData() {
            if (currentMetricFilter === 'all') {
                return globalData;
            }
            return globalData.filter(row => row['Metric'] === currentMetricFilter);
        }

        function updateAllSections() {
            const filteredData = getFilteredData();
            generateRecommendations(filteredData, globalHeaders);
            generateMetrics(filteredData, globalHeaders);
            generateLiftAnalysis(filteredData, globalHeaders);
            generateImpactCalculator(filteredData, globalHeaders);
            generateVisualization(filteredData, globalHeaders);
            generateTable(filteredData, globalHeaders);
        }

        function generateRecommendations(data, headers) {
            const section = document.getElementById('recommendationsSection');
            const recommendations = [];
            
            const controlRow = data.find(row => row['Variation Name'] && row['Variation Name'].toLowerCase().includes('control'));
            const variations = data.filter(row => row['Variation Name'] && !row['Variation Name'].toLowerCase().includes('control'));
            
            if (!controlRow || variations.length === 0) {
                section.innerHTML = '<h2>ü§ñ AI Recommendations</h2><p>No data available for selected filter.</p>';
                return;
            }
            
            let winner = null;
            let maxConfidence = 0;
            let maxLift = 0;
            
            variations.forEach(v => {
                const confidence = extractNumber(v['Better than Baseline']);
                const conversions = extractNumber(v['Unique Conversions']);
                const controlConversions = extractNumber(controlRow['Unique Conversions']);
                const visitors = extractNumber(v['Visitors']);
                const controlVisitors = extractNumber(controlRow['Visitors']);
                
                if (confidence && conversions && controlConversions && visitors && controlVisitors) {
                    const varRate = conversions / visitors;
                    const ctrlRate = controlConversions / controlVisitors;
                    const lift = ((varRate - ctrlRate) / ctrlRate) * 100;
                    
                    if (confidence > maxConfidence && confidence >= 95) {
                        maxConfidence = confidence;
                        maxLift = lift;
                        winner = v;
                    }
                }
            });
            
            const metricText = currentMetricFilter !== 'all' ? ` for ${currentMetricFilter}` : '';
            
            if (winner && maxConfidence >= 95) {
                recommendations.push({
                    type: 'success',
                    title: `üèÜ Deploy ${winner['Variation Name']}${metricText}`,
                    badge: 'RECOMMENDED',
                    content: `This variation shows a statistically significant improvement of ${maxLift.toFixed(2)}% with ${maxConfidence.toFixed(1)}% confidence. This is a clear winner and should be rolled out to all users.`
                });
            } else if (winner && maxConfidence >= 90) {
                recommendations.push({
                    type: 'warning',
                    title: `‚ö†Ô∏è Consider Running Test Longer${metricText}`,
                    badge: 'CAUTION',
                    content: `The best performing variation shows ${maxConfidence.toFixed(1)}% confidence. While promising, consider running the test longer to reach 95% statistical significance for a more reliable decision.`
                });
            } else {
                recommendations.push({
                    type: 'critical',
                    title: `‚ùå No Clear Winner Yet${metricText}`,
                    badge: 'INFO',
                    content: `None of the variations have reached statistical significance (95% confidence). Continue running the test and gathering more data before making a decision.`
                });
            }
            
            const controlVisitors = extractNumber(controlRow['Visitors']);
            if (controlVisitors && controlVisitors < 1000) {
                recommendations.push({
                    type: 'warning',
                    title: `üìä Increase Sample Size`,
                    badge: 'CAUTION',
                    content: `Your test has ${controlVisitors.toLocaleString()} visitors in the control group. For more reliable results, aim for at least 1,000 visitors per variation.`
                });
            }
            
            const controlConv = extractNumber(controlRow['Unique Conversions']);
            const controlVis = extractNumber(controlRow['Visitors']);
            if (controlConv && controlVis) {
  

const convRate = (controlConv / controlVis) * 100;
if (convRate < 1) {
recommendations.push({
type: 'warning',
title: `üìâ Low Base Conversion Rate`,
badge: 'INFO',
content: `Your control conversion rate is ${convRate.toFixed(2)}%. With low baseline conversion rates, you may need larger sample sizes to detect meaningful differences.`
});
}
}
          
          
          const goodVariations = variations.filter(v => {
            const conf = extractNumber(v['Better than Baseline']);
            return conf && conf >= 90;
        });
        
        if (goodVariations.length > 1) {
            recommendations.push({
                type: 'success',
                title: `üéØ Multiple Strong Performers`,
                badge: 'INFO',
                content: `You have ${goodVariations.length} variations performing well${metricText}. Consider analyzing qualitative factors alongside these quantitative results.`
            });
        }
        
        let html = '<h2>ü§ñ AI-Powered Recommendations' + metricText + '</h2>';
        recommendations.forEach(rec => {
            const cardClass = rec.type === 'success' ? '' : rec.type === 'warning' ? 'warning' : 'critical';
            const badgeClass = rec.type === 'success' ? 'badge-winner' : rec.type === 'warning' ? 'badge-caution' : 'badge-info';
            html += `
                <div class="recommendation-card ${cardClass}">
                    <h3>${rec.title} <span class="recommendation-badge ${badgeClass}">${rec.badge}</span></h3>
                    <p>${rec.content}</p>
                </div>
            `;
        });
        
        section.innerHTML = html;
    }

    function generateLiftAnalysis(data, headers) {
        const container = document.getElementById('liftCalculator');
        const controlRow = data.find(row => row['Variation Name'] && row['Variation Name'].toLowerCase().includes('control'));
        
        if (!controlRow) {
            container.innerHTML = '';
            return;
        }
        
        const controlConv = extractNumber(controlRow['Unique Conversions']);
        const controlVis = extractNumber(controlRow['Visitors']);
        
        if (!controlConv || !controlVis) {
            container.innerHTML = '';
            return;
        }
        
        const controlRate = (controlConv / controlVis) * 100;
        const metricText = currentMetricFilter !== 'all' ? ` (${currentMetricFilter})` : '';
        
        let html = `<h2>üìà Lift Analysis vs Control${metricText}</h2><div class="lift-grid">`;
        
        data.forEach(row => {
            const name = row['Variation Name'];
            if (!name || name.toLowerCase().includes('control')) return;
            
            const conv = extractNumber(row['Unique Conversions']);
            const vis = extractNumber(row['Visitors']);
            
            if (conv && vis) {
                const rate = (conv / vis) * 100;
                const lift = ((rate - controlRate) / controlRate) * 100;
                const absLift = rate - controlRate;
                const liftClass = lift > 0 ? 'positive' : lift < 0 ? 'negative' : '';
                const confidence = extractNumber(row['Better than Baseline']) || 0;
                
                html += `
                    <div class="lift-item">
                        <h4>${name}</h4>
                        <div class="lift-value ${liftClass}">
                            ${lift > 0 ? '+' : ''}${lift.toFixed(2)}%
                        </div>
                        <div style="font-size: 12px; color: #718096; margin-top: 5px;">
                            Relative lift: ${lift > 0 ? '+' : ''}${lift.toFixed(2)}%<br>
                            Absolute lift: ${absLift > 0 ? '+' : ''}${absLift.toFixed(2)}pp<br>
                            Confidence: ${confidence.toFixed(1)}%
                        </div>
                    </div>
                `;
            }
        });
        
        html += '</div>';
        container.innerHTML = html;
    }

    function generateImpactCalculator(data, headers) {
        const container = document.getElementById('impactCalculator');
        const controlRow = data.find(row => row['Variation Name'] && row['Variation Name'].toLowerCase().includes('control'));
        const winner = data.find(row => {
            const conf = extractNumber(row['Better than Baseline']);
            return conf && conf >= 95 && !row['Variation Name'].toLowerCase().includes('control');
        });
        
        if (!controlRow || !winner) {
            container.innerHTML = '';
            return;
        }
        
        const controlConv = extractNumber(controlRow['Unique Conversions']);
        const controlVis = extractNumber(controlRow['Visitors']);
        const winnerConv = extractNumber(winner['Unique Conversions']);
        const winnerVis = extractNumber(winner['Visitors']);
        
        if (!controlConv || !controlVis || !winnerConv || !winnerVis) {
            container.innerHTML = '';
            return;
        }
        
        const controlRate = controlConv / controlVis;
        const winnerRate = winnerConv / winnerVis;
        const lift = ((winnerRate - controlRate) / controlRate) * 100;
        
        const metricText = currentMetricFilter !== 'all' ? ` (${currentMetricFilter})` : '';
        
        let html = `
            <h2>üí∞ Impact Calculator${metricText}</h2>
            <div class="calculator-input">
                <label>Monthly Visitors:</label>
                <input type="number" id="monthlyVisitors" value="10000" min="0">
                <label>Value per Conversion ($):</label>
                <input type="number" id="conversionValue" value="50" min="0" step="0.01">
                <button class="export-btn" onclick="calculateImpact()">Calculate</button>
            </div>
            <div class="impact-result" id="impactResult">
                <h3>Projected Monthly Impact</h3>
                <div class="impact-value">$0.00</div>
                <p style="color: #4a5568; margin-top: 10px;">Enter values above and click Calculate</p>
            </div>
        `;
        
        container.innerHTML = html;
        
        container.dataset.controlRate = controlRate;
        container.dataset.winnerRate = winnerRate;
        container.dataset.lift = lift;
    }

    function calculateImpact() {
        const container = document.getElementById('impactCalculator');
        const monthlyVisitors = parseFloat(document.getElementById('monthlyVisitors').value) || 0;
        const conversionValue = parseFloat(document.getElementById('conversionValue').value) || 0;
        const controlRate = parseFloat(container.dataset.controlRate) || 0;
        const winnerRate = parseFloat(container.dataset.winnerRate) || 0;
        const lift = parseFloat(container.dataset.lift) || 0;
        
        const controlConversions = monthlyVisitors * controlRate;
        const winnerConversions = monthlyVisitors * winnerRate;
        const additionalConversions = winnerConversions - controlConversions;
        const monthlyImpact = additionalConversions * conversionValue;
        const annualImpact = monthlyImpact * 12;
        
        document.getElementById('impactResult').innerHTML = `
            <h3>Projected Monthly Impact</h3>
            <div class="impact-value">$${monthlyImpact.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
            <p style="color: #4a5568; margin-top: 10px;">
                <strong>+${additionalConversions.toFixed(0)} conversions/month</strong> (${lift.toFixed(2)}% lift)<br>
                Annual projection: <strong>$${annualImpact.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</strong>
            </p>
        `;
    }

    function generateReport(data, headers) {
        addDebug('üìä Generating report...');
        try {
            generateCampaignInfo(data, headers);
            setupMetricFilter(data, headers);
            updateAllSections();
            addDebug('‚úÖ Report complete!');
        } catch (error) {
            showError('Report error: ' + error.message);
            addDebug('‚ùå ' + error.stack);
        }
    }

    function generateCampaignInfo(data, headers) {
        const campaignInfo = document.getElementById('campaignInfo');
        const name = campaignMetadata.name || 'VWO Campaign';
        const id = campaignMetadata.id || 'N/A';
        
        const metrics = [...new Set(data.map(row => row['Metric']))];
        const variations = [...new Set(data.map(row => row['Variation Name']))];
        
        campaignInfo.innerHTML = `
            <h2>Campaign Overview</h2>
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">Campaign Name</div>
                    <div class="info-value">${name}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Campaign ID</div>
                    <div class="info-value">${id}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Variations</div>
                    <div class="info-value">${variations.length}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Metrics Tracked</div>
                    <div class="info-value">${metrics.length}</div>
                </div>
            </div>
        `;
    }

    function generateMetrics(data, headers) {
        const metricsGrid = document.getElementById('metricsGrid');
        metricsGrid.innerHTML = '';

        const numericColumns = ['Visitors', 'Unique Conversions'];
        
        numericColumns.forEach(col => {
            if (headers.includes(col)) {
                const values = data.map(row => extractNumber(row[col])).filter(v => v !== null);
                if (values.length > 0) {
                    const total = values.reduce((a, b) => a + b, 0);
                    const avg = total / values.length;
                    
                    const card = document.createElement('div');
                    card.className = 'metric-card';
                    card.innerHTML = `
                        <div class="metric-label">üìä Total ${col}</div>
                        <div class="metric-value">${total.toLocaleString()}</div>
                        <div class="metric-change neutral">Avg: ${avg.toLocaleString(undefined, {maximumFractionDigits: 0})}</div>
                    `;
                    metricsGrid.appendChild(card);
                }
            }
        });

        const controlRow = data.find(row => row['Variation Name'] && row['Variation Name'].toLowerCase().includes('control'));
        if (controlRow) {
            const visitors = extractNumber(controlRow['Visitors']);
            const conversions = extractNumber(controlRow['Unique Conversions']);
            if (visitors && conversions) {
                const rate = (conversions / visitors * 100).toFixed(2);
                const card = document.createElement('div');
                card.className = 'metric-card';
                card.innerHTML = `
                    <div class="metric-label">üìà Control Conv. Rate</div>
                    <div class="metric-value">${rate}%</div>
                    <div class="metric-change neutral">${conversions.toLocaleString()}/${visitors.toLocaleString()}</div>
                `;
                metricsGrid.appendChild(card);
            }
        }
        
        let bestVariation = null;
        let bestConfidence = 0;
        data.forEach(row => {
            const conf = extractNumber(row['Better than Baseline']);
            if (conf && conf > bestConfidence && !row['Variation Name'].toLowerCase().includes('control')) {
                bestConfidence = conf;
                bestVariation = row['Variation Name'];
            }
        });
        
        if (bestVariation) {
            const card = document.createElement('div');
            card.className = 'metric-card';
            const badgeClass = bestConfidence >= 95 ? 'positive' : bestConfidence >= 90 ? 'neutral' : 'negative';
            card.innerHTML = `
                <div class="metric-label">üèÜ Best Performer</div>
                <div class="metric-value" style="font-size: 20px;">${bestVariation}</div>
                <div class="metric-change ${badgeClass}">${bestConfidence.toFixed(1)}% confidence</div>
            `;
            metricsGrid.appendChild(card);
        }
    }

    function generateVisualization(data, headers) {
        const chartContainer = document.getElementById('chartContainer');
        
        const metrics = [...new Set(data.map(row => row['Metric']))];
        const displayMetric = currentMetricFilter !== 'all' ? currentMetricFilter : metrics[0];
        const metricData = data.filter(row => row['Metric'] === displayMetric);
        
        if (metricData.length === 0) {
            chartContainer.innerHTML = '<h2>Performance</h2><p style="color: #718096;">No data available for selected metric.</p>';
            return;
        }
        
        let html = `<h2>Performance: ${displayMetric}</h2>`;
        html += `<p style="color: #718096; margin-bottom: 20px;">Unique Conversions & Conversion Rate by Variation</p>`;
        
        const values = metricData.map(row => extractNumber(row['Unique Conversions']) || 0);
        const maxValue = Math.max(...values, 1);
        
        metricData.forEach((row, i) => {
            const label = row['Variation Name'] || `Variation ${i}`;
            const value = values[i];
            const visitors = extractNumber(row['Visitors']) || 0;
            const convRate = visitors > 0 ? ((value / visitors) * 100).toFixed(2) : '0.00';
            const confidence = extractNumber(row['Better than Baseline']) || 0;
            const pct = (value / maxValue) * 100;
            
            const isControl = label.toLowerCase().includes('control');
            let color = isControl ? '#718096' : (value > values[0] ? '#48bb78' : '#667eea');
            
            let confidenceBadge = '';
            if (!isControl && confidence >= 95) {
                confidenceBadge = '<span class="confidence-badge confidence-high">95%+ CONFIDENCE</span>';
            } else if (!isControl && confidence >= 90) {
                confidenceBadge = '<span class="confidence-badge confidence-medium">90%+ CONFIDENCE</span>';
            } else if (!isControl && confidence > 0) {
                confidenceBadge = '<span class="confidence-badge confidence-low">' + confidence.toFixed(0) + '% CONFIDENCE</span>';
            }
            
            html += `
                <div class="bar-item">
                    <div class="bar-header">
                        <span class="bar-label">${label} ${isControl ? '(Control)' : ''} ${confidenceBadge}</span>
                        <span class="bar-value" style="color: ${color};">${value.toLocaleString()} (${convRate}%)</span>
                    </div>
                    <div class="bar-bg">
                        <div class="bar-fill" style="background: ${color}; width: ${pct}%;"></div>
                    </div>
                </div>
            `;
        });
        
        chartContainer.innerHTML = html;
    }

    function setupMetricFilter(data, headers) {
        const filter = document.getElementById('metricFilter');
        const metrics = [...new Set(data.map(row => row['Metric']))];
        
        filter.innerHTML = '<option value="all">All Metrics</option>';
        metrics.forEach(metric => {
            filter.innerHTML += `<option value="${metric}">${metric}</option>`;
        });
        
        filter.addEventListener('change', () => {
            currentMetricFilter = filter.value;
            updateAllSections();
        });
    }

    function sortTable(column) {
        if (currentSort.column === column) {
            currentSort.ascending = !currentSort.ascending;
        } else {
            currentSort.column = column;
            currentSort.ascending = true;
        }
        
        const filteredData = getFilteredData();
        const sortedData = [...filteredData].sort((a, b) => {
            let aVal = a[column];
            let bVal = b[column];
            
            const aNum = extractNumber(aVal);
            const bNum = extractNumber(bVal);
            
            if (aNum !== null && bNum !== null) {
                return currentSort.ascending ? aNum - bNum : bNum - aNum;
            }
            
            aVal = String(aVal || '');
            bVal = String(bVal || '');
            
            if (currentSort.ascending) {
                return aVal.localeCompare(bVal);
            } else {
                return bVal.localeCompare(aVal);
            }
        });
        
        generateTable(sortedData, globalHeaders);
    }

    function generateTable(data, headers) {
        const tableContainer = document.getElementById('tableContainer');
        
        let html = '<table><thead><tr>';
        headers.forEach(h => {
            const sortIcon = currentSort.column === h ? 
                (currentSort.ascending ? '‚ñ≤' : '‚ñº') : '‚áÖ';
            const sortedClass = currentSort.column === h ? 'sorted' : '';
            html += `<th class="${sortedClass}" onclick="sortTable('${h}')">${h} <span class="sort-icon">${sortIcon}</span></th>`;
        });
        html += '</tr></thead><tbody>';

        data.forEach((row, i) => {
            html += '<tr>';
            headers.forEach((h, j) => {
                let val = row[h] ?? '-';
                
                if (h === 'Variation Name' && val.toLowerCase().includes('control')) {
                    val += ' <span class="control-badge">CONTROL</span>';
                }
                
                if (h === 'Better than Baseline') {
                    const confidence = extractNumber(val);
                    if (confidence && confidence >= 95) {
                        val += ' <span class="winner-badge">WINNER</span>';
                    }
                }
                
                html += `<td>${val}</td>`;
            });
            html += '</tr>';
        });

        html += '</tbody></table>';
        tableContainer.innerHTML = html;
    }

    function exportToCSV() {
        const filteredData = getFilteredData();
        const csv = Papa.unparse(filteredData);
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        const filename = currentMetricFilter !== 'all' ? 
            `vwo_report_${currentMetricFilter}_${Date.now()}.csv` : 
            `vwo_report_${Date.now()}.csv`;
        a.download = filename;
        a.click();
        window.URL.revokeObjectURL(url);
    }
</script>
  </body>
</html>
